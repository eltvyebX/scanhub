<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©   </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // --- Firebase Imports --- (Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, query, onSnapshot, serverTimestamp, setLogLevel, deleteDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables --- (Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        const API_KEY = ""; // Canvas provides this
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        const COLLECTION_NAME = "transactions";

        let db;
        let auth;
        let unsubscribe = null; 
        let transactionsData = [];
        let currentAuthUID = null; // Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ ÙÙŠ Firebase

        // --- Structured Output Schema for Gemini Vision --- (Ù…Ø®Ø·Ø· Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†Ø¸Ù…)
        const TRANSACTION_SCHEMA = {
            type: "OBJECT",
            properties: {
                trxIdLast4: { type: "STRING", description: "The last 4 alphanumeric digits of the Transaction ID (TrxID)." },
                date: { type: "STRING", description: "The transaction date in YYYY-MM-DD format." },
                time: { type: "STRING", description: "The transaction time in HH:MM (24-hour) format." },
                amount: { type: "NUMBER", description: "The numerical value of the transaction amount." }
            },
            required: ["trxIdLast4", "date", "time", "amount"]
        };

        // --- UI Helper Functions --- (Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
        function setLoading(id, isLoading, text = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
            const button = document.getElementById(id);
            if (button) {
                button.disabled = isLoading;
                button.classList.toggle('opacity-50', isLoading);
                button.textContent = isLoading ? text : button.dataset.originalText;
            }
        }
        
        function showMessage(type, message, containerId = 'messageContainer') {
            const container = document.getElementById(containerId);
            const color = type === 'error' ? 'bg-red-100 text-red-800 border-red-400' : 'bg-green-100 text-green-800 border-green-400';
            container.innerHTML = `<div class="p-3 rounded-lg border-r-4 ${color} mb-4">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 6000);
        }

        // --- Core Application and Utility Functions ---

        /** Converts File object to a Base64 string for the API payload. */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /** Gemini API Call (with Exponential Backoff) */
        async function fetchGemini(payload, retries = 3) {
            if (!navigator.onLine) { throw new Error("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª Gemini. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª."); }
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`ÙØ´Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API: ${errorBody.error?.message || response.statusText}`);
                    }

                    return await response.json();

                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("ÙØ´Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Gemini API Ø¨Ø¹Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©.");
        }

        /** Step 1: Scan the Image and Extract Data (Gemini Vision) */
        async function scanTransaction() {
            if (!currentAuthUID) {
                showMessage('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù†ØªØ¸Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            const imageInput = document.getElementById('imageInput');
            
            if (imageInput.files.length === 0) {
                showMessage('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            setLoading('scanButton', true);

            try {
                const file = imageInput.files[0];
                const base64Image = await fileToBase64(file);

                const systemInstruction = "You are a specialized financial data extractor. Analyze the provided image of a bank transaction receipt or screen and extract the date, time, last 4 digits of the transaction ID (TrxID), and the transaction amount. Output the result strictly as a JSON object matching the required schema.";
                const userPrompt = "Extract the key transaction details (Date, Time, last 4 digits of TrxID, and Amount) from this image.";

                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userPrompt },
                                {
                                    inlineData: {
                                        mimeType: file.type,
                                        data: base64Image
                                    }
                                }
                    ]
                        }
                    ],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: TRANSACTION_SCHEMA
                    }
                };

                const result = await fetchGemini(payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) throw new Error("API returned no structured content.");

                const extractedData = JSON.parse(jsonText);
                
                // Populate the EDITABLE input fields
                document.getElementById('extractedTrxIdInput').value = extractedData.trxIdLast4 || '';
                document.getElementById('extractedDateInput').value = extractedData.date || '';
                document.getElementById('extractedTimeInput').value = extractedData.time || '';
                document.getElementById('extractedAmountInput').value = extractedData.amount ? parseFloat(extractedData.amount).toFixed(2) : '0.00';
                
                document.getElementById('saveButton').disabled = false;
                
                showMessage('success', 'ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø±Ø§Ø¬Ø¹ ÙˆØ¹Ø¯Ù‘Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©".');
                
            } catch (error) {
                console.error("Scanning Error:", error);
                showMessage('error', `ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­: ${error.message}. Ù†Ø¸Ø±Ø§Ù‹ Ù„Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ù†ØªØ±Ù†ØªØŒ Ù„Ø§ ÙŠØ²Ø§Ù„ Ø¨Ø¥Ù…ÙƒØ§Ù†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙˆØ­ÙØ¸Ù‡Ø§.`);
            } finally {
                setLoading('scanButton', false);
            }
        }

        /** Step 2: Save Edited Data to Firestore */
        async function saveTransaction() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ…Ø¹Ø±Ù Firebase UID
            if (!currentAuthUID) {
                showMessage('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„.');
                return;
            }
            
            // ØªØ­Ù‚Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± (Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬)
            const saveButton = document.getElementById('saveButton');
            if (saveButton.disabled) return;

            setLoading('saveButton', true, 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...');

            try {
                // Read data directly from the editable input fields
                const data = {
                    date: document.getElementById('extractedDateInput').value || 'N/A', 
                    time: document.getElementById('extractedTimeInput').value || 'N/A',
                    trxIdLast4: document.getElementById('extractedTrxIdInput').value || 'N/A',
                    amount: parseFloat(document.getElementById('extractedAmountInput').value) || 0,
                };

                if (data.amount === 0) {
                     showMessage('error', 'Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙØ±Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©.');
                     setLoading('saveButton', false);
                     return;
                }

                // Private user collection path (ÙŠØ³ØªØ®Ø¯Ù… currentAuthUID Ù„ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†)
                const collectionPath = `artifacts/${appId}/users/${currentAuthUID}/${COLLECTION_NAME}`;
                
                await addDoc(collection(db, collectionPath), {
                    ...data,
                    timestamp: serverTimestamp(),
                    userId: currentAuthUID 
                });

                // Reset fields after successful save
                document.getElementById('extractedDateInput').value = '';
                document.getElementById('extractedTimeInput').value = '';
                document.getElementById('extractedTrxIdInput').value = '';
                document.getElementById('extractedAmountInput').value = '0.00';
                document.getElementById('saveButton').disabled = true;

                showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!');
                
            } catch (error) {
                console.error("Saving Error:", error);
                showMessage('error', `ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${error.message}`);
            } finally {
                setLoading('saveButton', false, 'Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
            }
        }
        window.saveTransaction = saveTransaction; // Make accessible from HTML
        
        /** Step 3: Delete Function */
        async function deleteTransaction(docId) {
             // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ…Ø¹Ø±Ù Firebase UID
            if (!currentAuthUID) {
                showMessage('error', 'Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°Ù.');
                return;
            }

            const confirmDelete = document.getElementById('confirmDeleteModal');
            // Attach the actual delete logic to the confirm button
            document.getElementById('confirmDeleteButton').onclick = async () => {
                confirmDelete.classList.add('hidden');
                
                try {
                    // ÙŠØ³ØªØ®Ø¯Ù… currentAuthUID Ù„ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†
                    const docPath = `artifacts/${appId}/users/${currentAuthUID}/${COLLECTION_NAME}/${docId}`;
                    await deleteDoc(doc(db, docPath));
                    showMessage('success', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.');
                } catch (error) {
                    console.error("Deletion Error:", error);
                    showMessage('error', `ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${error.message}`);
                }
            };
            
            // Show custom modal (replacing browser confirm())
            confirmDelete.classList.remove('hidden');
            document.getElementById('cancelDeleteButton').onclick = () => confirmDelete.classList.add('hidden');
        }
        window.deleteTransaction = deleteTransaction; 
        
        /** Step 5: Filter Handler */
        function handleMonthFilter() {
            const monthYearInput = document.getElementById('monthYearInput').value.trim();
            const regex = /^(\d{4})-(\d{2})$/; // YYYY-MM format

            if (monthYearInput === "") {
                // If empty, reset filter to show all
                loadTransactionsHistory(null, null);
                showMessage('success', 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØµÙÙŠØ©. Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª.');
                return;
            }

            if (!regex.test(monthYearInput)) {
                showMessage('error', 'ØµÙŠØºØ© Ø§Ù„Ø´Ù‡Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† YYYY-MMØŒ Ù…Ø«Ù„ 2024-05.', 'messageContainer');
                return;
            }

            const [_, year, month] = monthYearInput.match(regex);
            
            // Calculate start and end dates for the month
            const startDate = `${year}-${month}-01`;
            const nextMonth = parseInt(month) % 12 + 1;
            const nextYear = parseInt(month) === 12 ? parseInt(year) + 1 : parseInt(year);
            const nextMonthPadded = String(nextMonth).padStart(2, '0');
            const endDateExclusive = `${nextYear}-${nextMonthPadded}-01`;
            
            loadTransactionsHistory(startDate, endDateExclusive);
            showMessage('success', `ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰: ${monthYearInput}.`);
        }
        window.handleMonthFilter = handleMonthFilter; 


        /** Step 4: Fetch and Display Transaction History */
        function loadTransactionsHistory(startDate, endDateExclusive) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¹Ø±Ù Firebase UID
            if (!currentAuthUID) {
                // Do not load if the application's userId is not set/ready
                return; 
            }

            // Stop any existing listener
            if (unsubscribe) {
                unsubscribe();
            }

            // ÙŠØ³ØªØ®Ø¯Ù… currentAuthUID Ù„ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†
            const collectionPath = `artifacts/${appId}/users/${currentAuthUID}/${COLLECTION_NAME}`;
            const transactionsList = document.getElementById('transactionsList');
            let queryConstraints = [];
            
            // Add date range filters 
            if (startDate) {
                queryConstraints.push(where('date', '>=', startDate));
            }
            if (endDateExclusive) {
                queryConstraints.push(where('date', '<', endDateExclusive));
            }

            // IMPORTANT: We rely on client-side sorting by timestamp later
            const q = query(collection(db, collectionPath), ...queryConstraints); 

            transactionsList.innerHTML = '<p class="text-center text-gray-500 p-4">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...</p>';

            // Start new real-time listener
            unsubscribe = onSnapshot(q, (snapshot) => {
                let transactions = [];
                let totalAmount = 0; 

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const amount = parseFloat(data.amount) || 0;
                    transactions.push({...data, id: doc.id});
                    totalAmount += amount; 
                });

                // Client-side sorting by timestamp (descending) 
                transactions.sort((a, b) => {
                    const aTime = a.timestamp ? a.timestamp.toDate().getTime() : 0;
                    const bTime = b.timestamp ? b.timestamp.toDate().getTime() : 0;
                    return bTime - aTime;
                });
                
                transactionsData = transactions;

                // --- Display Total Sum (Updated Label) ---
                const totalDisplay = document.getElementById('totalSumDisplay');
                totalDisplay.innerHTML = `
                    <div class="p-4 bg-gray-100 border-2 border-gray-300 rounded-lg text-center">
                        <p class="text-sm font-medium text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</p>
                        <p class="text-3xl font-extrabold text-indigo-700 mt-1 ltr-input">$${totalAmount.toFixed(2)}</p>
                    </div>
                `;
                
                let html = '';
                transactions.forEach((data) => {
                    const dateYMD = data.date || 'N/A';
                    const time = data.time || '';
                    const amount = data.amount ? parseFloat(data.amount).toFixed(2) : '0.00';
                    const trxId = data.trxIdLast4 || '----';
                    
                    // Convert YYYY-MM-DD to DD-MM-YYYY for display
                    let dateDmy = dateYMD;
                    if (dateYMD !== 'N/A' && dateYMD.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = dateYMD.split('-');
                        dateDmy = `${day}-${month}-${year}`; 
                    }
                    
                    html += `
                        <div class="p-4 bg-white rounded-lg border-b border-gray-200 flex justify-between items-center transition hover:bg-gray-50">
                            <div class="space-y-0.5 text-right">
                                <p class="text-base font-semibold text-gray-800">Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø¢Ø®Ø± 4): ${trxId}</p>
                                <p class="text-xl font-extrabold text-green-700 ltr-input">$${amount}</p>
                                <p class="text-xs text-gray-500">${dateDmy} ÙÙŠ ${time}</p>
                            </div>
                            <button onclick="deleteTransaction('${data.id}')" id="delete-${data.id}" class="text-red-500 hover:text-red-700 p-2 rounded-full transition" title="Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                });

                transactionsList.innerHTML = html.length > 0 ? html : '<p class="text-center text-gray-500 p-4">Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯.</p>';
            }, (error) => {
                console.error("Failed to fetch transactions:", error);
                transactionsList.innerHTML = '<p class="text-center text-red-500 p-4">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„.</p>';
            });
        }

        /** Firebase Initialization and Anonymous Auth */
        async function initializeFirebase() {
            const appContainer = document.getElementById('appContainer');

            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                appContainer.innerHTML = `
                    <h2 class="text-3xl font-bold text-red-600 text-center">Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase</h2>
                    <p class="text-center text-sm text-gray-600 mt-4">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠÙØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆÙØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.</p>
                `;
                return; // CRITICAL: Exit early if config is missing
            }

            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            try {
                // Sign in anonymously immediately
                const userCredential = await signInAnonymously(auth);
                currentAuthUID = userCredential.user.uid;
                
                // Update UI with the UID
                document.getElementById('userIdDisplay').textContent = `Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID): ${currentAuthUID}`;
                
                // Load data
                loadTransactionsHistory(null, null);

                // Enable all relevant app buttons
                document.getElementById('scanButton').disabled = false;

            } catch (error) {
                console.error("Anonymous Sign-in Error:", error);
                document.getElementById('userIdDisplay').textContent = `ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„: ${error.message}`;
            }

            // Set the initial state for the app buttons
            document.getElementById('scanButton').dataset.originalText = 'Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
            document.getElementById('saveButton').dataset.originalText = 'Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
            document.getElementById('filterButton').dataset.originalText = 'ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±';
        }

        // --- Event Listeners and Init ---

        window.onload = function() {
            // Disable buttons until auth is complete
            document.getElementById('scanButton').disabled = true;
            document.getElementById('saveButton').disabled = true;
            
            initializeFirebase();
            
            // App Listeners
            document.getElementById('scanButton').addEventListener('click', scanTransaction);
            document.getElementById('saveButton').addEventListener('click', saveTransaction);
            document.getElementById('filterButton').addEventListener('click', handleMonthFilter); 
            
            // Image Preview handler and field reset 
            document.getElementById('imageInput').addEventListener('change', function(event) {
                const preview = document.getElementById('imagePreview');
                // Clear all input fields and disable save button on new image load
                document.getElementById('extractedDateInput').value = '';
                document.getElementById('extractedTimeInput').value = '';
                document.getElementById('extractedTrxIdInput').value = '';
                document.getElementById('extractedAmountInput').value = '0.00';
                document.getElementById('saveButton').disabled = true;

                if (event.target.files && event.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        document.getElementById('previewPlaceholder').classList.add('hidden');
                    }
                    reader.readAsDataURL(event.target.files[0]);
                }
            });
        };
    </script>
    <style>
        /* Minimalist Custom styles */
        .container {
            max-width: 800px;
        }
        .main-button {
            transition: background-color 0.2s, opacity 0.2s, border-color 0.2s;
            border-width: 2px;
            box-shadow: none; 
        }
        .main-button:hover:not(:disabled) {
            opacity: 0.9; 
            transform: none;
        }
        .main-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .editable-input {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            font-size: 1em;
            width: 100%;
            background-color: white;
            transition: border-color 0.2s;
            text-align: right; 
        }
        .ltr-input {
             text-align: left;
             direction: ltr;
             font-family: monospace;
        }
        .editable-input:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        #imagePreview {
            max-height: 200px;
            max-width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #eee; 
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased p-4 sm:p-8 text-right">
    
    <!-- Main Application Container - Now always visible -->
    <div id="appContainer" class="container mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-lg border border-gray-200 space-y-8">
        <header class="text-center border-b pb-4 flex justify-between items-start">
            <div>
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">
                    ğŸ’° Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© (ÙˆØµÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„)
                </h1>
                <p class="mt-2 text-base text-gray-600">
                    Ø§Ù…Ø³Ø­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©.
                </p>
                <p id="userIdDisplay" class="text-xs text-gray-500 mt-2">Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„...</p>
            </div>
        </header>

        <div id="messageContainer"></div>

        <!-- SECTION 1: Image Upload and Preview -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</h2>
            <div class="border border-gray-300 rounded-lg p-4 flex flex-col items-center justify-center">
                <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                
                <div id="previewPlaceholder" class="mt-4 text-gray-400">
                    Ø³ÙŠØ¸Ù‡Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§.
                </div>
                <img id="imagePreview" class="mt-4 hidden border" alt="Transaction Preview" />
            </div>
        </section>

        <!-- SECTION 2: Scanning and Extraction (Editable) -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
            
            <button id="scanButton"
                class="main-button w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 border-indigo-600 disabled:bg-gray-400">
                Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            </button>
            
            <div class="bg-white border border-gray-200 p-4 rounded-lg space-y-3">
                <h3 class="text-base font-semibold text-gray-800 mb-2">Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                    
                    <!-- TrxID (Last 4) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù…/Ø­Ø±ÙˆÙ)</label>
                        <input type="text" id="extractedTrxIdInput" class="editable-input ltr-input" value="" placeholder="Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù…" dir="ltr" />
                    </div>
                    
                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº ($)</label>
                        <input type="number" step="0.01" id="extractedAmountInput" class="editable-input ltr-input font-bold text-green-700" value="0.00" dir="ltr" />
                    </div>
                    
                    <!-- Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø³Ù†Ø©-Ø´Ù‡Ø±-ÙŠÙˆÙ…)</label>
                        <input type="text" id="extractedDateInput" class="editable-input ltr-input" value="" placeholder="YYYY-MM-DD" dir="ltr" />
                    </div>
                    
                    <!-- Time -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆÙ‚Øª (Ø³Ø§Ø¹Ø©:Ø¯Ù‚ÙŠÙ‚Ø©)</label>
                        <input type="text" id="extractedTimeInput" class="editable-input ltr-input" value="" placeholder="HH:MM" dir="ltr" />
                    </div>
                </div>
            </div>

            <button id="saveButton"
                data-data=""
                disabled
                onclick="saveTransaction()"
                class="main-button w-full px-4 py-3 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 disabled:bg-gray-400 border-green-500">
                Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            </button>
        </section>

        <!-- SECTION 3: Transaction History -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">3. Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (ÙˆÙ‚Øª Ø­Ù‚ÙŠÙ‚ÙŠ)</h2>
            
            <!-- Date Filter Inputs -->
            <div class="bg-gray-100 p-4 rounded-lg border border-gray-300 space-y-3">
                <h3 class="text-base font-semibold text-gray-700">Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label for="monthYearInput" class="block text-xs font-medium text-gray-600 mb-1">Ø´Ù‡Ø± Ø§Ù„ØªØµÙÙŠØ© (Ø³Ù†Ø©-Ø´Ù‡Ø±)</label>
                        <input type="text" id="monthYearInput" class="editable-input ltr-input" placeholder="Ù…Ø«Ø§Ù„: 2024-05" dir="ltr" />
                    </div>
                    <div class="self-end">
                        <button id="filterButton" onclick="handleMonthFilter()" class="main-button w-full px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300 border-gray-300">
                            ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±
                        </button>
                    </div>
                </div>
            </div>

            <!-- Total Sum Display -->
            <div id="totalSumDisplay" class="my-6">
                <!-- Total sum card will be injected here -->
            </div>
            
            <div id="transactionsList" class="space-y-3">
                <p class="text-center text-gray-500 p-4">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...</p>
            </div>
        </section>
        
        <!-- Custom Delete Confirmation Modal -->
        <div id="confirmDeleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm">
                <h3 class="text-lg font-bold text-red-600 mb-3">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                <p class="text-gray-700 mb-4">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù‡Ø°Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ</p>
                <div class="flex justify-start space-x-3 space-x-reverse">
                    <button id="cancelDeleteButton" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
                    <button id="confirmDeleteButton" class="px-4 py-2 text-white bg-red-600 rounded-md hover:bg-red-700 transition">Ø­Ø°Ù</button>
                </div>
            </div>
        </div>
    </div>
    
</body>
</html>
