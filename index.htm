<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ูุงุณุญ ุงูุฅุดุนุงุฑุงุช ุงูุจูููุฉ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js"></script>
<style>
  .card { @apply bg-white p-4 rounded-lg shadow-md border border-gray-200; }
</style>
</head>
<body class="bg-gray-50 min-h-screen p-6 font-sans">

<div class="container mx-auto max-w-lg space-y-6">

  <h1 class="text-3xl font-extrabold text-gray-800 text-center">๐ฐ ูุงุณุญ ุงูุฅุดุนุงุฑุงุช ุงูุจูููุฉ</h1>

  <!-- ุฑูุน ุงูุตูุฑุฉ -->
  <div class="card space-y-3">
    <h2 class="font-semibold text-gray-700">1๏ธโฃ ุฑูุน ุงูุตูุฑุฉ</h2>
    <input type="file" id="imageInput" accept="image/*" class="w-full border p-2 rounded">
    <button id="scanButton" class="w-full bg-indigo-600 text-white py-2 rounded mt-2 hover:bg-indigo-700">ูุณุญ ุงูุตูุฑุฉ</button>
  </div>

  <!-- ุนุฑุถ ุงูุจูุงูุงุช -->
  <div class="card space-y-3">
    <h2 class="font-semibold text-gray-700">2๏ธโฃ ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ</h2>
    <p>ุฑูู ุงูุนูููุฉ (ุขุฎุฑ 4 ุฃุฑูุงู): <span id="trxLast4">-</span></p>
    <p>ุงูุชุงุฑูุฎ ูุงูููุช: <span id="datetime">-</span></p>
    <p>ุงููุจูุบ ($): <span id="amount">-</span></p>
    <button id="saveButton" class="w-full bg-green-500 text-white py-2 rounded mt-2 hover:bg-green-600">ุญูุธ ุงููุนุงููุฉ</button>
  </div>

  <!-- ุณุฌู ุงููุนุงููุงุช -->
  <div class="card space-y-3">
    <h2 class="font-semibold text-gray-700">3๏ธโฃ ุณุฌู ุงููุนุงููุงุช</h2>
    <div id="transactionsList" class="space-y-2 text-gray-700">
      ูุง ุชูุฌุฏ ูุนุงููุงุช ุจุนุฏ.
    </div>
  </div>

</div>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MSG_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let extractedData = {};

  const imageInput = document.getElementById('imageInput');
  const scanButton = document.getElementById('scanButton');
  const saveButton = document.getElementById('saveButton');

  scanButton.addEventListener('click', async () => {
    if (!imageInput.files[0]) {
      alert("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุตูุฑุฉ ุฃููุงู!");
      return;
    }
    scanButton.textContent = "ุฌุงุฑู ุงููุณุญ...";
    const file = imageInput.files[0];

    const { data: { text } } = await Tesseract.recognize(file, 'eng+ara', { logger: m => console.log(m) });

    // ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
    const trxMatch = text.match(/Trx\.?ID[:\s]*([A-Za-z0-9]{4,})|ุฑูู ุงูุนูููุฉ[:\s]*([0-9]{4,})/i);
    const dateMatch = text.match(/\b(\d{4}[-\/]\d{2}[-\/]\d{2})\b/);
    const timeMatch = text.match(/\b(\d{2}:\d{2})\b/);
    const amountMatch = text.match(/amount[:\s]*([\d,.]+)|ุงููุจูุบ[:\s]*([\d,.]+)/i);

    extractedData = {
      trxLast4: trxMatch ? (trxMatch[1]||trxMatch[2]).slice(-4) : '',
      datetime: (dateMatch ? dateMatch[1] : '') + ' ' + (timeMatch ? timeMatch[1] : ''),
      amount: amountMatch ? parseFloat(amountMatch[1]||amountMatch[2].replace(/,/g,'')) : 0
    };

    document.getElementById('trxLast4').textContent = extractedData.trxLast4 || '-';
    document.getElementById('datetime').textContent = extractedData.datetime || '-';
    document.getElementById('amount').textContent = extractedData.amount.toFixed(2) || '-';

    scanButton.textContent = "ูุณุญ ุงูุตูุฑุฉ";
  });

  saveButton.addEventListener('click', () => {
    if (!extractedData.trxLast4) { alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ุตุงูุญุฉ ููุญูุธ!"); return; }
    const newRef = db.ref('receipts').push();
    newRef.set(extractedData, () => {
      alert("ุชู ุญูุธ ุงููุนุงููุฉ!");
      loadTransactions();
    });
  });

  function loadTransactions() {
    const list = document.getElementById('transactionsList');
    db.ref('receipts').once('value', snapshot => {
      const val = snapshot.val();
      if (!val) { list.innerHTML = "ูุง ุชูุฌุฏ ูุนุงููุงุช ุจุนุฏ."; return; }
      let html = '';
      Object.values(val).forEach(item => {
        html += `<div class="p-2 border rounded bg-gray-50">
          <p>ุฑูู ุงูุนูููุฉ: ${item.trxLast4}</p>
          <p>ุงูุชุงุฑูุฎ ูุงูููุช: ${item.datetime}</p>
          <p>ุงููุจูุบ: $${item.amount.toFixed(2)}</p>
        </div>`;
      });
      list.innerHTML = html;
    });
  }

  loadTransactions();
</script>

</body>
</html>
