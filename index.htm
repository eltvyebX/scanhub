<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© - Gemini & Firestore V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase/Firestore/Auth Imports for Cloud Storage -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, deleteDoc, onSnapshot, collection, addDoc, setLogLevel, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables --- (Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©)
        
        let app, db, auth;
        let userId = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        let isAuthReady = false;

        // ** Mandatory Canvas Environment Variables **
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const COLLECTION_NAME = "transactions_for_merchants";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/";
        const apiKey = ""; // Canvas provides this key automatically
        
        let transactionsData = [];
        

        // --- UI Helper Functions ---
        function setLoading(id, isLoading, text = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
            const button = document.getElementById(id);
            if (button) {
                button.disabled = isLoading;
                button.classList.toggle('opacity-50', isLoading);
                button.textContent = isLoading ? text : button.dataset.originalText;
            }
        }
        
        function showMessage(type, message, containerId = 'messageContainer') {
            const container = document.getElementById(containerId);
            const color = type === 'error' ? 'bg-red-100 text-red-800 border-red-400' : 'bg-green-100 text-green-800 border-green-400';
            container.innerHTML = `<div class="p-3 rounded-lg border-r-4 ${color} mb-4">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 6000);
        }
        
        // --- Firestore Functions (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©) ---
        
        /** Gets the collection reference (Using the Public path for shared/merchant data) */
        function getCollectionRef() {
            if (!userId || !db) return null;
            // Path: /artifacts/{appId}/public/data/transactions_for_merchants
            // Using 'public' ensures all merchants can view the data saved in this app instance.
            return collection(db, `artifacts/${appId}/public/data/${COLLECTION_NAME}`);
        }

        /** Sets up real-time listener for transaction data */
        function setupTransactionListener() {
            if (!isAuthReady || !db || !userId) return;

            const collectionRef = getCollectionRef();
            if (!collectionRef) return;
            
            // Listen to data changes in real-time (onSnapshot)
            onSnapshot(collectionRef, (snapshot) => {
                const tempTransactions = [];
                snapshot.forEach((doc) => {
                    tempTransactions.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort client-side by timestamp descending
                tempTransactions.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 
                transactionsData = tempTransactions;
                displayTransactionsHistory();
                
                showMessage('success', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.', 'messageContainer');
            }, (error) => {
                console.error("Error setting up Firestore listener:", error);
                showMessage('error', `ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: ${error.message}`, 'messageContainer');
            });
        }

        /** Saves a single transaction (uses addDoc) */
        async function saveTransaction(data) {
            if (!db || !userId) {
                showMessage('error', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ÙØ¸. ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.', 'messageContainer');
                return;
            }
            
            const collectionRef = getCollectionRef();
            if (!collectionRef) return;

            const newTrx = {
                timestamp: Date.now(),
                date: data.date, 
                time: data.time,
                trxIdLast4: data.trxIdLast4,
                amount: data.amount,
                savedBy: userId
            };

            await addDoc(collectionRef, newTrx);
            showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©!');
        }

        /** * Deletes a transaction (uses deleteDoc) 
         * IMPROVED: Added robust error handling to help diagnose deployment issues (e.g., Permission Denied)
         */
        async function deleteTransaction(docId) {
            if (!db || !userId) {
                showMessage('error', 'Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø­Ø°Ù Ø¨Ø¯ÙˆÙ† Ù…ØµØ§Ø¯Ù‚Ø©.', 'messageContainer');
                return;
            }

            const collectionRef = getCollectionRef();
            if (!collectionRef) {
                showMessage('error', 'Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù…Ø³Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©.', 'messageContainer');
                return;
            }
            
            try {
                const docRef = doc(collectionRef, docId);
                await deleteDoc(docRef);
                showMessage('success', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'messageContainer');
            } catch(error) {
                 console.error("Error deleting document:", error);
                 // Display the specific Firebase error in the UI to help the user diagnose the Security Rules issue
                 let errorMessage = error.message.includes('permission denied') 
                    ? `ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†. (Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firebase)` 
                    : `ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${error.message}`;
                 showMessage('error', errorMessage, 'messageContainer');
            }
        }
        window.deleteTransaction = deleteTransaction; 
        
        // --- Gemini API Scanning Logic ---

        /** Step 1: Scan the Image and Extract Data (Gemini API) */
        async function scanTransaction() {
            const imageInput = document.getElementById('imageInput');
            if (imageInput.files.length === 0) {
                showMessage('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.', 'messageContainer');
                return;
            }

            const file = imageInput.files[0];
            setLoading('scanButton', true, 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø³Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gemini API...');

            try {
                // 1. Read file as Base64
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });

                // 2. Define the prompt for structured data extraction
                const userPrompt = `
                    Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¥ÙŠØµØ§Ù„Ø§Øª ÙˆÙ…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¯ÙØ¹.
                    Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø¯Ù‚Ø©:
                    1. Ø§Ù„Ù…Ø¨Ù„Øº (Amount): Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ø¯Ø¯ÙŠØ© ÙÙ‚Ø·ØŒ Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ² Ø¹Ù…Ù„Ø©.
                    2. Ø§Ù„ØªØ§Ø±ÙŠØ® (Date): Ø¨ØµÙŠØºØ© YYYY-MM-DD.
                    3. Ø§Ù„ÙˆÙ‚Øª (Time): Ø¨ØµÙŠØºØ© HH:MM (Ø¨Ù†Ø¸Ø§Ù… 24 Ø³Ø§Ø¹Ø©).
                    4. Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (TrxId): Ø¢Ø®Ø± 4 Ù…Ø­Ø§Ø±Ù (Ø£Ø±Ù‚Ø§Ù…/Ø­Ø±ÙˆÙ) Ù…Ù† Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ÙŠ Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.
                    
                    ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨ØµÙŠØºØ© JSON ÙÙ‚Ø·ØŒ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ù…Ø­Ø¯Ø¯.
                    Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© null.
                `;
                
                // 3. Define JSON Schema for Structured Output
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: userPrompt },
                            {
                                inlineData: {
                                    mimeType: file.type,
                                    data: base64Data
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "amount": { "type": "NUMBER", description: "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø¯Ø¯ÙŠ Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø©." },
                                "date": { "type": "STRING", description: "Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© YYYY-MM-DD." },
                                "time": { "type": "STRING", description: "Ø§Ù„ÙˆÙ‚Øª Ø¨ØµÙŠØºØ© HH:MM (24 Ø³Ø§Ø¹Ø©)." },
                                "trxIdLast4": { "type": "STRING", description: "Ø¢Ø®Ø± 4 Ù…Ø­Ø§Ø±Ù Ù…Ù† Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©." }
                            },
                            required: ["amount", "date", "time", "trxIdLast4"]
                        }
                    },
                };

                // 4. API Call with exponential backoff for reliability
                const apiUrl = `${API_URL_BASE}${GEMINI_MODEL}:generateContent?key=${apiKey}`;
                
                let response;
                let result;
                const MAX_RETRIES = 3;

                for (let i = 0; i < MAX_RETRIES; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    result = await response.json();
                    
                    if (response.status === 200 && result.candidates && result.candidates.length > 0) {
                        break; // Success
                    }
                    
                    if (i < MAX_RETRIES - 1) {
                         // Wait before retry (exponential backoff)
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    } else {
                        throw new Error(result.error?.message || "ÙØ´Ù„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ ÙÙŠ Gemini API Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª.");
                    }
                }

                const jsonText = result.candidates[0].content.parts[0].text;
                const extractedData = JSON.parse(jsonText);

                // 5. Populate Input Fields
                document.getElementById('extractedTrxIdInput').value = extractedData.trxIdLast4 || '';
                document.getElementById('extractedDateInput').value = extractedData.date || '';
                document.getElementById('extractedTimeInput').value = extractedData.time || '';
                document.getElementById('extractedAmountInput').value = extractedData.amount ? parseFloat(extractedData.amount).toFixed(2) : '0.00';
                
                document.getElementById('saveButton').disabled = false;
                
                showMessage('success', 'ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gemini! Ø±Ø§Ø¬Ø¹ ÙˆØ¹Ø¯Ù‘Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©".', 'messageContainer');

            } catch (error) {
                console.error("Scanning Error:", error);
                showMessage('error', `ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­: ${error.message}. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`, 'messageContainer');
            } finally {
                setLoading('scanButton', false);
            }
        }
        window.scanTransaction = scanTransaction; // FIX: Expose function to global scope

        /** Step 2: Save Edited Data to Firestore */
        async function handleSaveTransaction() {
            const saveButton = document.getElementById('saveButton');
            if (saveButton.disabled) return;

            setLoading('saveButton', true, 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...');

            try {
                // Read data directly from the editable input fields
                const data = {
                    date: document.getElementById('extractedDateInput').value || 'N/A', 
                    time: document.getElementById('extractedTimeInput').value || 'N/A',
                    trxIdLast4: document.getElementById('extractedTrxIdInput').value || 'N/A',
                    amount: parseFloat(document.getElementById('extractedAmountInput').value) || 0,
                };

                if (data.amount <= 0) {
                     showMessage('error', 'Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ Ù…ÙˆØ¬Ø¨Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'messageContainer');
                     setLoading('saveButton', false);
                     return;
                }

                await saveTransaction(data); // Call the Firestore save function

                // Reset fields after successful save
                document.getElementById('extractedDateInput').value = '';
                document.getElementById('extractedTimeInput').value = '';
                document.getElementById('extractedTrxIdInput').value = '';
                document.getElementById('extractedAmountInput').value = '0.00';
                document.getElementById('saveButton').disabled = true;

                
            } catch (error) {
                console.error("Saving Error:", error);
                showMessage('error', `ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${error.message}`);
            } finally {
                setLoading('saveButton', false, 'Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
            }
        }
        window.handleSaveTransaction = handleSaveTransaction; 
        
        
        /** Step 5: Filter Handler */
        function handleMonthFilter() {
            const monthYearInput = document.getElementById('monthYearInput').value.trim();
            const regex = /^(\d{4})-(\d{2})$/; // YYYY-MM format
            
            let filteredTransactions = transactionsData;

            if (monthYearInput !== "") {
                if (!regex.test(monthYearInput)) {
                    showMessage('error', 'ØµÙŠØºØ© Ø§Ù„Ø´Ù‡Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† YYYY-MMØŒ Ù…Ø«Ù„ 2024-05.', 'messageContainer');
                    return;
                }

                const [_, year, month] = monthYearInput.match(regex);
                
                filteredTransactions = transactionsData.filter(trx => {
                    if (trx.date && typeof trx.date === 'string' && trx.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        return trx.date.startsWith(`${year}-${month}`);
                    }
                    return false;
                });
                showMessage('success', `ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰: ${monthYearInput}.`);
            } else {
                 showMessage('success', 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØµÙÙŠØ©. Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª.');
            }

            displayTransactionsHistory(filteredTransactions);
        }
        window.handleMonthFilter = handleMonthFilter; 


        /** Step 4: Display Transaction History */
        function displayTransactionsHistory(transactions = transactionsData) {
            const transactionsList = document.getElementById('transactionsList');
            let totalAmount = 0; 
            
            transactionsList.innerHTML = '<p class="text-center text-gray-500 p-4">Ø¬Ø§Ø±Ù Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...</p>';


            // Calculate total sum for filtered/all data
            transactions.forEach((data) => {
                totalAmount += (parseFloat(data.amount) || 0); 
            });

            // --- Display Total Sum ---
            const totalDisplay = document.getElementById('totalSumDisplay');
            totalDisplay.innerHTML = `
                <div class="p-4 bg-gray-100 border-2 border-gray-300 rounded-lg text-center">
                    <p class="text-sm font-medium text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</p>
                    <p class="text-3xl font-extrabold text-indigo-700 mt-1 ltr-input">$${totalAmount.toFixed(2)}</p>
                </div>
            `;
            
            let html = '';
            transactions.forEach((data) => {
                const dateYMD = data.date || 'N/A';
                const time = data.time || '';
                const amount = data.amount ? parseFloat(data.amount).toFixed(2) : '0.00';
                const trxId = data.trxIdLast4 || '----';
                const savedBy = data.savedBy ? data.savedBy.substring(0, 8) + '...' : 'Unknown';
                
                // Convert YYYY-MM-DD to DD-MM-YYYY for display
                let dateDmy = dateYMD;
                if (dateYMD !== 'N/A' && typeof dateYMD === 'string' && dateYMD.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const parts = dateYMD.split('-');
                    if (parts.length === 3) {
                       dateDmy = `${parts[2]}-${parts[1]}-${parts[0]}`; 
                    }
                }
                
                html += `
                    <div class="p-4 bg-white rounded-lg border-b border-gray-200 flex justify-between items-center transition hover:bg-gray-50">
                        <div class="space-y-0.5 text-right">
                            <p class="text-base font-semibold text-gray-800">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ø§Ø®Ø± 4 Ø§Ø±Ù‚Ø§Ù…): ${trxId}</p>
                            <p class="text-xl font-extrabold text-green-700 ltr-input">$${amount}</p>
                            <p class="text-xs text-gray-500">${dateDmy} ÙÙŠ ${time} - Ø¨ÙˆØ§Ø³Ø·Ø© ${savedBy}</p>
                        </div>
                        <button onclick="deleteTransaction('${data.id}')" id="delete-${data.id}" class="text-red-500 hover:text-red-700 p-2 rounded-full transition" title="Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
            });

            transactionsList.innerHTML = html.length > 0 ? html : '<p class="text-center text-gray-500 p-4">Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯.</p>';
        }

        /** Initialization and Authentication */
        async function initFirebase() {
            if (!firebaseConfig) {
                showMessage('error', 'Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªÙˆÙÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.', 'messageContainer');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); 

                // 1. Sign In (using the provided token or anonymously)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('userIdDisplay').textContent = `Ù…Ø¹Ø±Ù‘Ù Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${userId}`;
                        setupTransactionListener(); // Start listening to Firestore data
                    } else {
                        userId = crypto.randomUUID(); // Fallback ID if sign-in fails
                        isAuthReady = true; 
                        document.getElementById('userIdDisplay').textContent = `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©. ${userId}`;
                        showMessage('error', 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ. Ù‚Ø¯ Ù„Ø§ ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù….', 'messageContainer');
                        transactionsData = [];
                        displayTransactionsHistory();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage('error', `ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${error.message}`, 'messageContainer');
            }
        }

        /** Run on Window Load */
        window.onload = function() {
            // Set the initial state for the app buttons
            document.getElementById('scanButton').dataset.originalText = 'Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
            document.getElementById('saveButton').dataset.originalText = 'Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
            document.getElementById('filterButton').dataset.originalText = 'ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±';
            document.getElementById('saveButton').disabled = true;

            // Initialize Firebase and start auth process
            initFirebase(); 
            
            // App Listeners
            document.getElementById('scanButton').addEventListener('click', scanTransaction);
            document.getElementById('saveButton').addEventListener('click', handleSaveTransaction);
            document.getElementById('filterButton').addEventListener('click', handleMonthFilter); 
            
            // Image Preview handler and field reset 
            document.getElementById('imageInput').addEventListener('change', function(event) {
                const preview = document.getElementById('imagePreview');
                // Clear all input fields and disable save button on new image load
                document.getElementById('extractedDateInput').value = '';
                document.getElementById('extractedTimeInput').value = '';
                document.getElementById('extractedTrxIdInput').value = '';
                document.getElementById('extractedAmountInput').value = '0.00';
                document.getElementById('saveButton').disabled = true;

                if (event.target.files && event.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        document.getElementById('previewPlaceholder').classList.add('hidden');
                    }
                    reader.readAsDataURL(event.target.files[0]);
                }
            });
        };
        
    </script>
    <style>
        /* Minimalist Custom styles */
        .container {
            max-width: 800px;
        }
        .main-button {
            transition: background-color 0.2s, opacity 0.2s, border-color 0.2s;
            border-width: 2px;
            box-shadow: none; 
        }
        .main-button:hover:not(:disabled) {
            opacity: 0.9; 
            transform: none;
        }
        .main-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .editable-input {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            font-size: 1em;
            width: 100%;
            background-color: white;
            transition: border-color 0.2s;
            text-align: right; 
        }
        .ltr-input {
             text-align: left;
             direction: ltr;
             font-family: monospace;
        }
        .editable-input:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        #imagePreview {
            max-height: 200px;
            max-width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #eee; 
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased p-4 sm:p-8 text-right">
    
    <!-- Main Application Container -->
    <div id="appContainer" class="container mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-lg border border-gray-200 space-y-8">
        <header class="text-center border-b pb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">
                ğŸš€ Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© (Gemini & Firestore)
            </h1>
            <p class="mt-2 text-base text-gray-600">
                Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gemini API ÙˆØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ Ø¹Ø¨Ø± Firestore.
            </p>
            <p id="userIdDisplay" class="text-xs text-indigo-600 font-semibold mt-2">
                Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ...
            </p>
        </header>

        <div id="messageContainer"></div>

        <!-- SECTION 1: Image Upload and Preview -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</h2>
            <div class="border border-gray-300 rounded-lg p-4 flex flex-col items-center justify-center">
                <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                
                <div id="previewPlaceholder" class="mt-4 text-gray-400">
                    Ø³ÙŠØ¸Ù‡Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§.
                </div>
                <img id="imagePreview" class="mt-4 hidden border" alt="Transaction Preview" />
            </div>
        </section>

        <!-- SECTION 2: Scanning and Extraction (Editable) -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">2. Ù…Ø³Ø­ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
            
            <button id="scanButton"
                onclick="scanTransaction()"
                class="main-button w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 border-indigo-600 disabled:bg-gray-400">
                Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            </button>
            
            <div class="bg-white border border-gray-200 p-4 rounded-lg space-y-3">
                <h3 class="text-base font-semibold text-gray-800 mb-2">Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                    
                    <!-- TrxID (Last 4) - UPDATED TEXT -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ø§Ø®Ø± 4 Ø§Ø±Ù‚Ø§Ù…)</label>
                        <input type="text" id="extractedTrxIdInput" class="editable-input ltr-input" value="" placeholder="Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù…" dir="ltr" />
                    </div>
                    
                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº ($)</label>
                        <input type="number" step="0.01" id="extractedAmountInput" class="editable-input ltr-input font-bold text-green-700" value="0.00" dir="ltr" />
                    </div>
                    
                    <!-- Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø³Ù†Ø©-Ø´Ù‡Ø±-ÙŠÙˆÙ…)</label>
                        <input type="text" id="extractedDateInput" class="editable-input ltr-input" value="" placeholder="YYYY-MM-DD" dir="ltr" />
                    </div>
                    
                    <!-- Time -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆÙ‚Øª (Ø³Ø§Ø¹Ø©:Ø¯Ù‚ÙŠÙ‚Ø©)</label>
                        <input type="text" id="extractedTimeInput" class="editable-input ltr-input" value="" placeholder="HH:MM" dir="ltr" />
                    </div>
                </div>
            </div>

            <button id="saveButton"
                disabled
                onclick="handleSaveTransaction()"
                class="main-button w-full px-4 py-3 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 disabled:bg-gray-400 border-green-500">
                Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            </button>
        </section>

        <!-- SECTION 3: Transaction History -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">3. Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Firestore)</h2>
            
            <!-- Date Filter Inputs -->
            <div class="bg-gray-100 p-4 rounded-lg border border-gray-300 space-y-3">
                <h3 class="text-base font-semibold text-gray-700">Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label for="monthYearInput" class="block text-xs font-medium text-gray-600 mb-1">Ø´Ù‡Ø± Ø§Ù„ØªØµÙÙŠØ© (Ø³Ù†Ø©-Ø´Ù‡Ø±)</label>
                        <input type="text" id="monthYearInput" class="editable-input ltr-input" placeholder="Ù…Ø«Ø§Ù„: 2024-05" dir="ltr" />
                    </div>
                    <div class="self-end">
                        <button id="filterButton" onclick="handleMonthFilter()" class="main-button w-full px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300 border-gray-300">
                            ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±
                        </button>
                    </div>
                </div>
            </div>

            <!-- Total Sum Display -->
            <div id="totalSumDisplay" class="my-6">
                <!-- Total sum card will be injected here -->
            </div>
            
            <div id="transactionsList" class="space-y-3">
                <p class="text-center text-gray-500 p-4">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...</p>
            </div>
        </section>
        
    </div>
    
</body>
</html>
