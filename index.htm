<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© - ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // --- Firebase Imports --- (Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, updateCurrentUser, signInWithCustomToken as authSignInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, onSnapshot, serverTimestamp, setLogLevel, deleteDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables --- (Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const API_KEY = ""; // Canvas provides this
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        const COLLECTION_NAME = "transactions";
        const PIN_REGISTRY_PATH = `artifacts/${appId}/public/data/pins_registry`; // Ù…Ø³Ø§Ø± Ø¹Ø§Ù… Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø³Ø±ÙŠØ©

        let db;
        let auth;
        let isAuthReady = false; // Ù‡Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¬Ø§Ù‡Ø²Ø©ØŸ
        let isAuthorized = false; // Ù‡Ù„ ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­ØŸ (Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ UI/Firestore)
        let unsubscribe = null; 
        let transactionsData = [];
        let currentAuthUID = null; // Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙØ¹Ù„ÙŠ ÙÙŠ Firebase

        // --- Structured Output Schema for Gemini Vision --- (Ù…Ø®Ø·Ø· Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†Ø¸Ù…)
        const TRANSACTION_SCHEMA = {
            type: "OBJECT",
            properties: {
                trxIdLast4: { type: "STRING", description: "The last 4 alphanumeric digits of the Transaction ID (TrxID)." },
                date: { type: "STRING", description: "The transaction date in YYYY-MM-DD format." },
                time: { type: "STRING", description: "The transaction time in HH:MM (24-hour) format." },
                amount: { type: "NUMBER", description: "The numerical value of the transaction amount." }
            },
            required: ["trxIdLast4", "date", "time", "amount"]
        };

        // --- UI Helper Functions --- (Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
        function setLoading(id, isLoading, text = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
            const button = document.getElementById(id);
            if (button) {
                button.disabled = isLoading;
                button.classList.toggle('opacity-50', isLoading);
                button.textContent = isLoading ? text : button.dataset.originalText;
            }
        }
        
        function showMessage(type, message, containerId = 'messageContainer') {
            const container = document.getElementById(containerId);
            const color = type === 'error' ? 'bg-red-100 text-red-800 border-red-400' : 'bg-green-100 text-green-800 border-green-400';
            container.innerHTML = `<div class="p-3 rounded-lg border-r-4 ${color} mb-4">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 6000);
        }

        // --- PIN AUTHENTICATION FUNCTIONS --- (Ø¯ÙˆØ§Ù„ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ)
        
        /** Generates a random 6-digit PIN. (ÙŠÙˆÙ„Ù‘Ø¯ Ø±Ù…Ø² Ø³Ø±ÙŠ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…) */
        function generatePin() {
            return String(Math.floor(100000 + Math.random() * 900000));
        }

        /** Register a new user by generating a PIN and associating it with a new anonymous UID. */
        async function registerPin() {
            const showPinDiv = document.getElementById('showPin');
            setLoading('registerButton', true, 'Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ù…Ø²...');
            showPinDiv.innerHTML = '';
            document.getElementById('authMessageContainer').innerHTML = '';

            try {
                // 1. Sign in anonymously if not already (ensures currentAuthUID is set)
                if (!currentAuthUID) {
                     await signInAnonymously(auth);
                }
                
                const newPin = generatePin();
                
                // 2. Check if the PIN already exists
                const pinDocRef = doc(db, PIN_REGISTRY_PATH, newPin);
                const pinSnap = await getDoc(pinDocRef);

                if (pinSnap.exists()) {
                    return registerPin(); // Retry if PIN is somehow duplicated
                }

                // 3. Save the new PIN linked to the current user's UID (currentAuthUID)
                await setDoc(pinDocRef, { 
                    uid: currentAuthUID, 
                    createdAt: serverTimestamp()
                });

                // 4. Authorization success
                isAuthorized = true;

                showPinDiv.innerHTML = `<div class="p-4 bg-gray-100 rounded-lg text-center font-bold text-lg text-gray-800 border border-gray-300">
                                            Ø±Ù…Ø²Ùƒ Ø§Ù„Ø³Ø±ÙŠ Ù‡Ùˆ: <span class="ltr-input font-mono text-xl">${newPin}</span>
                                        </div>
                                        <p class="text-sm text-center text-red-600 mt-2">Ø§Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ø¬ÙŠØ¯Ø§Ù‹. Ø³ØªØ­ØªØ§Ø¬Ù‡ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!</p>`;
                
                showMessage('success', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­!', 'authMessageContainer');
                
                // Transition UI and start data loading
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                document.getElementById('userIdDisplay').textContent = `Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID): ${currentAuthUID}`;
                loadTransactionsHistory(null, null);

            } catch (error) {
                console.error("PIN Registration Error:", error);
                showMessage('error', `ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ù…Ø²: ${error.message}`, 'authMessageContainer');
            } finally {
                setLoading('registerButton', false);
            }
        }
        window.registerPin = registerPin; // Make accessible from HTML

        /** Logs in by checking the entered PIN against the registry. */
        async function loginByPIN() {
            const inputPin = document.getElementById('inputPin').value.trim();
            setLoading('loginButton', true, 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...');
            document.getElementById('authMessageContainer').innerHTML = '';

            try {
                if (inputPin.length !== 6 || isNaN(inputPin)) {
                    showMessage('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø³Ø±ÙŠ ØµØ­ÙŠØ­ Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù….', 'authMessageContainer');
                    setLoading('loginButton', false);
                    return;
                }
                
                // 1. Ensure the current user is authenticated (anonymous is fine)
                 if (!currentAuthUID) {
                     await signInAnonymously(auth);
                }

                // 2. Look up the PIN in the public registry
                const pinDocRef = doc(db, PIN_REGISTRY_PATH, inputPin);
                const pinSnap = await getDoc(pinDocRef);

                if (!pinSnap.exists() || !pinSnap.data().uid) {
                    throw new Error("Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ø¬Ù„.");
                }

                const targetUid = pinSnap.data().uid;

                // 3. CRITICAL CHECK: Ensure the PIN is linked to the currently authenticated UID
                if (currentAuthUID !== targetUid) {
                    // This is necessary because we cannot switch the Firebase user's authentication token 
                    // in this environment. The data stored must belong to the current authenticated UID.
                    throw new Error("Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù„Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø°ÙŠ Ø³Ø¬Ù„ØªÙ‡ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯.");
                }
                
                // 4. Authorization success
                isAuthorized = true;

                showMessage('success', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'authMessageContainer');
                
                // Manually transition UI and start data loading
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                document.getElementById('userIdDisplay').textContent = `Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID): ${currentAuthUID}`;
                loadTransactionsHistory(null, null);

            } catch (error) {
                console.error("PIN Login Error:", error);
                showMessage('error', error.message, 'authMessageContainer');
            } finally {
                setLoading('loginButton', false);
            }
        }
        window.loginByPIN = loginByPIN; // Make accessible from HTML

        async function handleSignOut() {
            try {
                // Reset the application's authorization state
                isAuthorized = false; 
                
                if (unsubscribe) {
                     unsubscribe(); // Stop listening to data
                }

                // Re-enable the auth screen and hide the app container
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
                
                document.getElementById('showPin').innerHTML = '';
                document.getElementById('inputPin').value = '';

                showMessage('success', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.');

                // Force a reload or sign-in anonymously again to get a fresh UID if needed,
                // but usually, a simple sign out is enough to hide private data.
                
            } catch (error) {
                console.error("Sign Out Error:", error);
                showMessage('error', 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.');
            }
        }
        window.handleSignOut = handleSignOut; 

        // --- Core Application and Utility Functions ---

        /** Converts File object to a Base64 string for the API payload. */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /** Gemini API Call (with Exponential Backoff) */
        async function fetchGemini(payload, retries = 3) {
            if (!navigator.onLine) { throw new Error("Cannot connect to Gemini API. Please check your internet connection."); }
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API call failed: ${errorBody.error?.message || response.statusText}`);
                    }

                    return await response.json();

                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Gemini API call failed after multiple retries.");
        }

        /** Step 1: Scan the Image and Extract Data (Gemini Vision) */
        async function scanTransaction() {
            if (!currentAuthUID || !isAuthorized) {
                showMessage('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­.');
                return;
            }

            const imageInput = document.getElementById('imageInput');
            
            if (imageInput.files.length === 0) {
                showMessage('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            setLoading('scanButton', true);

            try {
                const file = imageInput.files[0];
                const base64Image = await fileToBase64(file);

                const systemInstruction = "You are a specialized financial data extractor. Analyze the provided image of a bank transaction receipt or screen and extract the date, time, last 4 digits of the transaction ID (TrxID), and the transaction amount. Output the result strictly as a JSON object matching the required schema.";
                const userPrompt = "Extract the key transaction details (Date, Time, last 4 digits of TrxID, and Amount) from this image.";

                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userPrompt },
                                {
                                    inlineData: {
                                        mimeType: file.type,
                                        data: base64Image
                                    }
                                }
                    ]
                        }
                    ],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: TRANSACTION_SCHEMA
                    }
                };

                const result = await fetchGemini(payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText) throw new Error("API returned no structured content.");

                const extractedData = JSON.parse(jsonText);
                
                // Populate the EDITABLE input fields
                document.getElementById('extractedTrxIdInput').value = extractedData.trxIdLast4 || '';
                document.getElementById('extractedDateInput').value = extractedData.date || '';
                document.getElementById('extractedTimeInput').value = extractedData.time || '';
                document.getElementById('extractedAmountInput').value = extractedData.amount ? parseFloat(extractedData.amount).toFixed(2) : '0.00';
                
                document.getElementById('saveButton').disabled = false;
                
                showMessage('success', 'ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø±Ø§Ø¬Ø¹ ÙˆØ¹Ø¯Ù‘Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©".');
                
            } catch (error) {
                console.error("Scanning Error:", error);
                showMessage('error', `ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­: ${error.message}. Ù†Ø¸Ø±Ø§Ù‹ Ù„Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ù†ØªØ±Ù†ØªØŒ Ù„Ø§ ÙŠØ²Ø§Ù„ Ø¨Ø¥Ù…ÙƒØ§Ù†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙˆØ­ÙØ¸Ù‡Ø§.`);
            } finally {
                setLoading('scanButton', false);
            }
        }

        /** Step 2: Save Edited Data to Firestore */
        async function saveTransaction() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ…Ø¹Ø±Ù Firebase UID
            if (!currentAuthUID || !isAuthorized) {
                showMessage('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ.');
                return;
            }
            
            // ØªØ­Ù‚Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
            if (document.getElementById('saveButton').disabled) return;


            setLoading('saveButton', true, 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...');

            try {
                // Read data directly from the editable input fields
                const data = {
                    date: document.getElementById('extractedDateInput').value || 'N/A', 
                    time: document.getElementById('extractedTimeInput').value || 'N/A',
                    trxIdLast4: document.getElementById('extractedTrxIdInput').value || 'N/A',
                    amount: parseFloat(document.getElementById('extractedAmountInput').value) || 0,
                };

                if (data.amount === 0) {
                     showMessage('error', 'Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙØ±Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©.');
                     return;
                }

                // Private user collection path (ÙŠØ³ØªØ®Ø¯Ù… currentAuthUID Ù„ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†)
                const collectionPath = `artifacts/${appId}/users/${currentAuthUID}/${COLLECTION_NAME}`;
                
                await addDoc(collection(db, collectionPath), {
                    ...data,
                    timestamp: serverTimestamp(),
                    userId: currentAuthUID 
                });

                // Reset fields after successful save
                document.getElementById('extractedDateInput').value = '';
                document.getElementById('extractedTimeInput').value = '';
                document.getElementById('extractedTrxIdInput').value = '';
                document.getElementById('extractedAmountInput').value = '0.00';
                document.getElementById('saveButton').disabled = true;

                showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!');
                
            } catch (error) {
                console.error("Saving Error:", error);
                showMessage('error', `ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${error.message}`);
            } finally {
                setLoading('saveButton', false, 'Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
            }
        }
        window.saveTransaction = saveTransaction; // Make accessible from HTML

        /** Step 3: Delete Function */
        async function deleteTransaction(docId) {
             // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ…Ø¹Ø±Ù Firebase UID
            if (!currentAuthUID || !isAuthorized) {
                showMessage('error', 'Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°Ù.');
                return;
            }

            const confirmDelete = document.getElementById('confirmDeleteModal');
            // Attach the actual delete logic to the confirm button
            document.getElementById('confirmDeleteButton').onclick = async () => {
                confirmDelete.classList.add('hidden');
                
                try {
                    // ÙŠØ³ØªØ®Ø¯Ù… currentAuthUID Ù„ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†
                    const docPath = `artifacts/${appId}/users/${currentAuthUID}/${COLLECTION_NAME}/${docId}`;
                    await deleteDoc(doc(db, docPath));
                    showMessage('success', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.');
                } catch (error) {
                    console.error("Deletion Error:", error);
                    showMessage('error', `ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${error.message}`);
                }
            };
            
            // Show custom modal (replacing browser confirm())
            confirmDelete.classList.remove('hidden');
            document.getElementById('cancelDeleteButton').onclick = () => confirmDelete.classList.add('hidden');
        }
        window.deleteTransaction = deleteTransaction; 

        /** Step 4: Fetch and Display Transaction History */
        function loadTransactionsHistory(startDate, endDate) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙ…Ø¹Ø±Ù Firebase UID
            if (!currentAuthUID || !isAuthorized) {
                // Do not load if the application's logical userId is not set/ready
                return; 
            }

            // Stop any existing listener
            if (unsubscribe) {
                unsubscribe();
            }

            // ÙŠØ³ØªØ®Ø¯Ù… currentAuthUID Ù„ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†
            const collectionPath = `artifacts/${appId}/users/${currentAuthUID}/${COLLECTION_NAME}`;
            const transactionsList = document.getElementById('transactionsList');
            let queryConstraints = [];
            
            // Add date range filters 
            if (startDate) {
                queryConstraints.push(where('date', '>=', startDate));
            }
            if (endDate) {
                queryConstraints.push(where('date', '<=', endDate));
            }

            const q = query(collection(db, collectionPath), ...queryConstraints); 

            transactionsList.innerHTML = '<p class="text-center text-gray-500 p-4">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...</p>';

            // Start new real-time listener
            unsubscribe = onSnapshot(q, (snapshot) => {
                let transactions = [];
                let totalAmount = 0; 

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const amount = parseFloat(data.amount) || 0;
                    transactions.push({...data, id: doc.id});
                    totalAmount += amount; 
                });

                // Client-side sorting by timestamp (descending) 
                transactions.sort((a, b) => {
                    const aTime = a.timestamp ? a.timestamp.toDate().getTime() : 0;
                    const bTime = b.timestamp ? b.timestamp.toDate().getTime() : 0;
                    return bTime - aTime;
                });
                
                transactionsData = transactions;

                // --- Display Total Sum (Updated Label) ---
                const totalDisplay = document.getElementById('totalSumDisplay');
                totalDisplay.innerHTML = `
                    <div class="p-4 bg-gray-100 border-2 border-gray-300 rounded-lg text-center">
                        <p class="text-sm font-medium text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</p>
                        <p class="text-3xl font-extrabold text-indigo-700 mt-1 ltr-input">$${totalAmount.toFixed(2)}</p>
                    </div>
                `;
                
                let html = '';
                transactions.forEach((data) => {
                    const dateYMD = data.date || 'N/A';
                    const time = data.time || '';
                    const amount = data.amount ? parseFloat(data.amount).toFixed(2) : '0.00';
                    const trxId = data.trxIdLast4 || '----';
                    
                    // Convert YYYY-MM-DD to DD-MM-YYYY for display
                    let dateDmy = dateYMD;
                    if (dateYMD !== 'N/A' && dateYMD.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = dateYMD.split('-');
                        dateDmy = `${day}-${month}-${year}`; 
                    }
                    
                    html += `
                        <div class="p-4 bg-white rounded-lg border-b border-gray-200 flex justify-between items-center transition hover:bg-gray-50">
                            <div class="space-y-0.5 text-right">
                                <p class="text-base font-semibold text-gray-800">Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø¢Ø®Ø± 4): ${trxId}</p>
                                <p class="text-xl font-extrabold text-green-700 ltr-input">$${amount}</p>
                                <p class="text-xs text-gray-500">${dateDmy} ÙÙŠ ${time}</p>
                            </div>
                            <button onclick="deleteTransaction('${data.id}')" id="delete-${data.id}" class="text-red-500 hover:text-red-700 p-2 rounded-full transition" title="Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                });

                transactionsList.innerHTML = html.length > 0 ? html : '<p class="text-center text-gray-500 p-4">Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯.</p>';
            }, (error) => {
                console.error("Failed to fetch transactions:", error);
                transactionsList.innerHTML = '<p class="text-center text-red-500 p-4">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„.</p>';
            });
        }

        /** Handles Month/Year filter input to calculate date range */
        function handleMonthFilter() {
            const monthYearString = document.getElementById('monthYearInput').value.trim();

            if (!monthYearString) {
                // If empty, reload all data
                loadTransactionsHistory(null, null);
                return;
            }

            // Simple validation for YYYY-MM format
            const parts = monthYearString.match(/^(\d{4})-(\d{2})$/);
            if (!parts) {
                showMessage('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø© Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ YYYY-MM Ø¨Ø¯Ù‚Ø© (Ù…Ø«Ø§Ù„: 2024-05).');
                return;
            }

            const year = parseInt(parts[1]);
            const month = parseInt(parts[2]); // 1-indexed month (1-12)

            // Calculate the last day of the target month
            const lastDayOfMonth = new Date(year, month, 0).getDate();
            
            // Construct the start and end date strings for Firestore filtering (YYYY-MM-DD)
            const startDate = `${monthYearString}-01`;
            const endDate = `${monthYearString}-${String(lastDayOfMonth).padStart(2, '0')}`;

            loadTransactionsHistory(startDate, endDate);
        }
        window.handleMonthFilter = handleMonthFilter; // Make accessible from HTML

        /** Firebase Initialization and Auth */
        async function initializeFirebase() {
            if (!firebaseConfig) return console.error("Firebase config is missing.");

            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            const authScreen = document.getElementById('authScreen');
            const appContainer = document.getElementById('appContainer');
            
            // 1. Handle initial auth token from canvas (if provided)
            if (initialAuthToken) {
                try {
                    await authSignInWithCustomToken(auth, initialAuthToken);
                } catch (e) {
                    console.warn("Custom token failed or not needed, proceeding to anonymous sign in.", e);
                }
            }

            // 2. Ensure an anonymous user is always signed in
            if (!auth.currentUser) {
                 await signInAnonymously(auth);
            }

            // 3. Authentication listener
            onAuthStateChanged(auth, async (user) => {
                currentAuthUID = user ? user.uid : null;
                isAuthReady = true;

                // Only transition to app if Firebase UID is set AND PIN is authorized
                if (currentAuthUID && isAuthorized) { 
                    appContainer.classList.remove('hidden');
                    authScreen.classList.add('hidden');
                    document.getElementById('userIdDisplay').textContent = `Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID): ${currentAuthUID}`;
                    loadTransactionsHistory(null, null); 
                } else {
                    appContainer.classList.add('hidden');
                    authScreen.classList.remove('hidden');
                    document.getElementById('userIdDisplay').textContent = `Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ.`;
                    if (unsubscribe) {
                         unsubscribe(); 
                    }
                }
            });

            // Set the initial state for the auth buttons
            document.getElementById('registerButton').dataset.originalText = 'Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø³Ø±ÙŠ';
            document.getElementById('loginButton').dataset.originalText = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        }

        // --- Event Listeners and Init ---

        window.onload = function() {
            initializeFirebase();
            
            // App Buttons Init
            document.getElementById('scanButton').dataset.originalText = 'Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
            document.getElementById('saveButton').dataset.originalText = 'Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
            document.getElementById('filterButton').dataset.originalText = 'ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±';
            
            // App Listeners
            document.getElementById('scanButton').addEventListener('click', scanTransaction);
            document.getElementById('saveButton').addEventListener('click', saveTransaction);
            document.getElementById('filterButton').addEventListener('click', handleMonthFilter); 
            
            // Image Preview handler and field reset 
            document.getElementById('imageInput').addEventListener('change', function(event) {
                const preview = document.getElementById('imagePreview');
                // Clear all input fields and disable save button on new image load
                document.getElementById('extractedDateInput').value = '';
                document.getElementById('extractedTimeInput').value = '';
                document.getElementById('extractedTrxIdInput').value = '';
                document.getElementById('extractedAmountInput').value = '0.00';
                document.getElementById('saveButton').disabled = true;

                if (event.target.files && event.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        document.getElementById('previewPlaceholder').classList.add('hidden');
                    }
                    reader.readAsDataURL(event.target.files[0]);
                }
            });
        };
    </script>
    <style>
        /* Minimalist Custom styles */
        .container {
            max-width: 800px;
        }
        .main-button {
            transition: background-color 0.2s, opacity 0.2s, border-color 0.2s;
            border-width: 2px;
            box-shadow: none; 
        }
        .main-button:hover:not(:disabled) {
            opacity: 0.9; 
            transform: none;
        }
        .main-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .editable-input {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            font-size: 1em;
            width: 100%;
            background-color: white;
            transition: border-color 0.2s;
            text-align: right; 
        }
        .ltr-input {
             text-align: left;
             direction: ltr;
             font-family: monospace;
        }
        .editable-input:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        #imagePreview {
            max-height: 200px;
            max-width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #eee; 
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased p-4 sm:p-8 text-right">
    
    <!-- Authentication Screen (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ) -->
    <div id="authScreen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="p-8 rounded-xl w-11/12 max-w-md space-y-6 border border-gray-200 shadow-lg">
            <h2 id="authTitle" class="text-3xl font-bold text-gray-800 text-center">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ</h2>
            <p class="text-center text-gray-500">
                Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ø°Ù‡ Ø£ÙˆÙ„ Ù…Ø±Ø© Ù„ÙƒØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø³Ø±ÙŠ.
            </p>

            <div id="authMessageContainer"></div> 

            <!-- PIN Registration Section -->
            <div class="space-y-4 pt-2">
                <button id="registerButton"
                    onclick="registerPin()"
                    data-original-text="Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø³Ø±ÙŠ"
                    class="main-button w-full px-4 py-3 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 border-blue-500">
                    Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø³Ø±ÙŠ
                </button>
                <div id="showPin" class="mt-4">
                    <!-- The generated PIN will appear here -->
                </div>
            </div>

            <!-- PIN Login Section -->
            <div class="space-y-4 pt-4 border-t border-gray-200">
                <div>
                    <label for="inputPin" class="block text-sm font-medium text-gray-700 mb-1">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ</label>
                    <input type="tel" id="inputPin" maxlength="6" class="editable-input ltr-input text-center text-xl font-mono" placeholder="123456" dir="ltr" />
                </div>

                <button id="loginButton"
                    onclick="loginByPIN()"
                    data-original-text="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"
                    class="main-button w-full px-4 py-3 bg-indigo-500 text-white font-semibold rounded-md hover:bg-indigo-600 border-indigo-500">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
            </div>
            
        </div>
    </div>
    
    <!-- Main Application Container -->
    <div id="appContainer" class="container mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-lg border border-gray-200 space-y-8 hidden">
        <header class="text-center border-b pb-4 flex justify-between items-start">
            <div>
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">
                    ğŸ’° Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©
                </h1>
                <p class="mt-2 text-base text-gray-600">
                    Ø§Ù…Ø³Ø­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù† Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©.
                </p>
                <p id="userIdDisplay" class="text-xs text-gray-500 mt-2"></p>
            </div>
            
            <!-- Sign Out Button -->
            <button onclick="handleSignOut()" class="main-button px-3 py-1 bg-white text-red-500 border-2 border-red-500 font-semibold rounded-md hover:bg-red-50 transition text-sm flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h6a1 1 0 110 2H4v10h2a1 1 0 110 2H4a2 2 0 01-2-2V4a2 2 0 012-2zm13.707 6.707a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H10a1 1 0 110-2h4.586l-1.293-1.293a1 1 0 011.414-1.414l4 4z" clip-rule="evenodd" />
                </svg>
                Ø®Ø±ÙˆØ¬
            </button>
        </header>

        <div id="messageContainer"></div>

        <!-- SECTION 1: Image Upload and Preview -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</h2>
            <div class="border border-gray-300 rounded-lg p-4 flex flex-col items-center justify-center">
                <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                
                <div id="previewPlaceholder" class="mt-4 text-gray-400">
                    Ø³ÙŠØ¸Ù‡Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§.
                </div>
                <img id="imagePreview" class="mt-4 hidden border" alt="Transaction Preview" />
            </div>
        </section>

        <!-- SECTION 2: Scanning and Extraction (Editable) -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
            
            <button id="scanButton"
                class="main-button w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 border-indigo-600">
                Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            </button>
            
            <div class="bg-white border border-gray-200 p-4 rounded-lg space-y-3">
                <h3 class="text-base font-semibold text-gray-800 mb-2">Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                    
                    <!-- TrxID (Last 4) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù…/Ø­Ø±ÙˆÙ)</label>
                        <input type="text" id="extractedTrxIdInput" class="editable-input ltr-input" value="" placeholder="Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù…" dir="ltr" />
                    </div>
                    
                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº ($)</label>
                        <input type="number" step="0.01" id="extractedAmountInput" class="editable-input ltr-input font-bold text-green-700" value="0.00" dir="ltr" />
                    </div>
                    
                    <!-- Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø³Ù†Ø©-Ø´Ù‡Ø±-ÙŠÙˆÙ…)</label>
                        <input type="text" id="extractedDateInput" class="editable-input ltr-input" value="" placeholder="YYYY-MM-DD" dir="ltr" />
                    </div>
                    
                    <!-- Time -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆÙ‚Øª (Ø³Ø§Ø¹Ø©:Ø¯Ù‚ÙŠÙ‚Ø©)</label>
                        <input type="text" id="extractedTimeInput" class="editable-input ltr-input" value="" placeholder="HH:MM" dir="ltr" />
                    </div>
                </div>
            </div>

            <button id="saveButton"
                data-data=""
                disabled
                onclick="saveTransaction()"
                class="main-button w-full px-4 py-3 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 disabled:bg-gray-400 border-green-500">
                Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            </button>
        </section>

        <!-- SECTION 3: Transaction History -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">3. Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (ÙˆÙ‚Øª Ø­Ù‚ÙŠÙ‚ÙŠ)</h2>
            
            <!-- Date Filter Inputs -->
            <div class="bg-gray-100 p-4 rounded-lg border border-gray-300 space-y-3">
                <h3 class="text-base font-semibold text-gray-700">Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label for="monthYearInput" class="block text-xs font-medium text-gray-600 mb-1">Ø´Ù‡Ø± Ø§Ù„ØªØµÙÙŠØ© (Ø³Ù†Ø©-Ø´Ù‡Ø±)</label>
                        <input type="text" id="monthYearInput" class="editable-input ltr-input" placeholder="Ù…Ø«Ø§Ù„: 2024-05" dir="ltr" />
                    </div>
                    <div class="self-end">
                        <button id="filterButton" onclick="handleMonthFilter()" class="main-button w-full px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300 border-gray-300">
                            ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±
                        </button>
                    </div>
                </div>
            </div>

            <!-- Total Sum Display -->
            <div id="totalSumDisplay" class="my-6">
                <!-- Total sum card will be injected here -->
            </div>
            
            <div id="transactionsList" class="space-y-3">
                <p class="text-center text-gray-500 p-4">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...</p>
            </div>
        </section>
        
        <!-- Custom Delete Confirmation Modal -->
        <div id="confirmDeleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm">
                <h3 class="text-lg font-bold text-red-600 mb-3">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                <p class="text-gray-700 mb-4">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù‡Ø°Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ</p>
                <div class="flex justify-start space-x-3 space-x-reverse">
                    <button id="cancelDeleteButton" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
                    <button id="confirmDeleteButton" class="px-4 py-2 text-white bg-red-600 rounded-md hover:bg-red-700 transition">Ø­Ø°Ù</button>
                </div>
            </div>
        </div>
    </div>
    
</body>
</html>
