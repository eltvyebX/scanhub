<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© - Tesseract & LocalStorage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tesseract.js for Client-Side OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script type="module">
        // --- Global Variables --- (Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©)
        // ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… AppId Ù„ØªØ¹ÙŠÙŠÙ† Ù†Ø·Ø§Ù‚ Ù„Ø¨ÙŠØ§Ù†Ø§Øª localStorage
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const LOCAL_STORAGE_KEY = `trx_scanner_${appId}`;
        const COLLECTION_NAME = "transactions";

        let transactionsData = [];
        let worker = null; // Tesseract Worker

        // --- UI Helper Functions --- (Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
        function setLoading(id, isLoading, text = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
            const button = document.getElementById(id);
            if (button) {
                button.disabled = isLoading;
                button.classList.toggle('opacity-50', isLoading);
                button.textContent = isLoading ? text : button.dataset.originalText;
            }
        }
        
        function showMessage(type, message, containerId = 'messageContainer') {
            const container = document.getElementById(containerId);
            const color = type === 'error' ? 'bg-red-100 text-red-800 border-red-400' : 'bg-green-100 text-green-800 border-green-400';
            container.innerHTML = `<div class="p-3 rounded-lg border-r-4 ${color} mb-4">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 6000);
        }

        // --- Local Storage Functions (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Firebase) ---
        
        /** Loads transactions from local storage. */
        function loadTransactions() {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedData) {
                    transactionsData = JSON.parse(storedData);
                    // Sort client-side by timestamp descending
                    transactionsData.sort((a, b) => b.timestamp - a.timestamp);
                } else {
                    transactionsData = [];
                }
            } catch (error) {
                console.error("Error loading from localStorage:", error);
                transactionsData = [];
            }
            displayTransactionsHistory();
        }

        /** Saves the current transaction list to local storage. */
        function saveTransactionsToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(transactionsData));
            } catch (error) {
                console.error("Error saving to localStorage:", error);
                showMessage('error', 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù…ØªØµÙØ­Ùƒ.', 'messageContainer');
            }
        }

        /** Saves a single transaction (replaces addDoc in Firestore) */
        function saveTransaction(data) {
            const newTrx = {
                id: crypto.randomUUID(), // Unique ID for deletion
                timestamp: Date.now(),
                ...data
            };
            transactionsData.unshift(newTrx); // Add to the start
            saveTransactionsToLocal();
            displayTransactionsHistory();
            showMessage('success', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù…ØªØµÙØ­!');
        }
        
        /** Deletes a transaction (replaces deleteDoc in Firestore) */
        function deleteTransaction(docId) {
            const index = transactionsData.findIndex(trx => trx.id === docId);
            if (index !== -1) {
                transactionsData.splice(index, 1);
                saveTransactionsToLocal();
                displayTransactionsHistory();
                showMessage('success', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ.');
            }
        }
        window.deleteTransaction = deleteTransaction; 

        // --- Tesseract OCR and Parsing Functions ---

        /** Converts File object to a Base64 string for Tesseract. */
        function fileToTesseractInput(file) {
            // Tesseract can often take the File object directly, but for consistency/preview:
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /** Tesseract OCR Parsing Logic (Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù…) */
        function parseOCRText(text) {
            const data = {
                trxIdLast4: 'N/A',
                date: 'N/A',
                time: 'N/A',
                amount: 0.00
            };

            // 1. Amount (Find currency symbols or just large numbers/decimals)
            // ÙŠØ¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø¨ÙØ§ØµÙ„Ø© Ø¹Ø´Ø±ÙŠØ© Ù…Ø³Ø¨ÙˆÙ‚Ù‹Ø§ Ø¨Ø±Ù…Ø² Ø¹Ù…Ù„Ø© Ù…Ø­ØªÙ…Ù„ (Ù…Ø«Ù„ $ØŒ SARØŒ Ø¯.Ø¥) Ø£Ùˆ ÙƒÙ„Ù…Ø© (Ù…Ø«Ù„ amount, total)
            const amountRegex = /(?:[A-Z$]|SAR|Ø¯\.Ø¥|Ø±ÙŠØ§Ù„|Ø¯ÙˆÙ„Ø§Ø±|Ù…Ø¨Ù„Øº|Amount|Total|Ø§Ù„Ù‚ÙŠÙ…Ø©)\s*[:=]?\s*(\d{1,3}(?:[,\s]\d{3})*(?:\.\d{1,2})?|\d+\.\d{1,2})/i;
            
            const amountMatch = text.match(amountRegex);
            if (amountMatch) {
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙÙˆØ§ØµÙ„ (Commas/Spaces) ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒØ¹Ø¯Ø¯
                const cleanAmount = amountMatch[1].replace(/[,\s]/g, '');
                data.amount = parseFloat(cleanAmount) || 0;
            } else {
                 // fallback for simple number with two decimals
                 const simpleAmountRegex = /\b(\d+\.\d{2})\b/;
                 const simpleAmountMatch = text.match(simpleAmountRegex);
                 if (simpleAmountMatch) {
                    data.amount = parseFloat(simpleAmountMatch[1]) || 0;
                 }
            }


            // 2. Date (YYYY-MM-DD or DD/MM/YYYY or YYYY/MM/DD) -> Standardize to YYYY-MM-DD
            const dateRegex1 = /(\d{4})[-/](\d{1,2})[-/](\d{1,2})/; // YYYY-MM-DD
            const dateRegex2 = /(\d{1,2})[-/](\d{1,2})[-/](\d{4})/; // DD/MM/YYYY

            let dateMatch = text.match(dateRegex1);
            if (dateMatch) {
                data.date = `${dateMatch[1]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[3].padStart(2, '0')}`;
            } else {
                dateMatch = text.match(dateRegex2);
                if (dateMatch) {
                    data.date = `${dateMatch[3]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[1].padStart(2, '0')}`;
                }
            }

            // 3. Time (HH:MM or HH:MM:SS) -> Standardize to HH:MM
            const timeRegex = /\b(\d{1,2}):(\d{2})(?::\d{2})?\s*(?:AM|PM|Øµ|Ù…|ØµØ¨Ø§Ø­Ø§|Ù…Ø³Ø§Ø¡)?\b/g;
            const timeMatch = Array.from(text.matchAll(timeRegex)).pop(); // Ø®Ø° Ø¢Ø®Ø± ÙˆÙ‚Øª ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡
            if (timeMatch) {
                data.time = `${timeMatch[1].padStart(2, '0')}:${timeMatch[2]}`;
            }

            // 4. TrxID (Ø¢Ø®Ø± 4 Ù…Ø­Ø§Ø±Ù)
            const trxIdKeywordsRegex = /(?:TrxID|ID|Reference|Ø§Ù„Ù…Ø±Ø¬Ø¹|Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©|Ø±Ù‚Ù…)\s*[:#]*\s*([A-Z0-9]{4,})/i;
            const trxIdMatch = text.match(trxIdKeywordsRegex);
            if (trxIdMatch) {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¢Ø®Ø± 4 Ù…Ø­Ø§Ø±Ù
                const fullId = trxIdMatch[1].replace(/[^A-Z0-9]/ig, ''); 
                data.trxIdLast4 = fullId.slice(-4).toUpperCase();
            } else {
                 // Fallback: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø³Ù„Ø³Ù„Ø© Ù…Ù† 4-8 Ø£Ø­Ø±Ù/Ø£Ø±Ù‚Ø§Ù… ÙƒØ¨ÙŠØ±Ø©
                 const genericIdRegex = /([A-Z0-9]{4,8})/g;
                 const genericMatches = Array.from(text.matchAll(genericIdRegex)).map(m => m[1]);
                 if(genericMatches.length > 0) {
                     data.trxIdLast4 = genericMatches.pop().slice(-4).toUpperCase();
                 }
            }
            
            // Log the raw text for debugging regex
            console.log("OCR Raw Text:", text);
            console.log("Parsed Data:", data);

            return data;
        }


        /** Step 1: Scan the Image and Extract Data (Tesseract OCR) */
        async function scanTransaction() {
            const imageInput = document.getElementById('imageInput');
            
            if (imageInput.files.length === 0) {
                showMessage('error', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            setLoading('scanButton', true, 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø³Ø­...');

            try {
                const file = imageInput.files[0];
                const imageSrc = await fileToTesseractInput(file);

                // Check and create Tesseract worker
                if (!worker) {
                     setLoading('scanButton', true, 'Ø¬Ø§Ø±Ù ØªÙ‡ÙŠØ¦Ø© Tesseract...');
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… eng+ara Ù„Ø²ÙŠØ§Ø¯Ø© Ø¯Ù‚Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ø®ØªÙ„Ø·Ø©
                    worker = await Tesseract.createWorker('eng+ara'); 
                }

                // Run OCR
                const result = await worker.recognize(imageSrc);
                const extractedText = result.data.text;
                
                if (!extractedText) throw new Error("Tesseract Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Øµ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©.");

                const extractedData = parseOCRText(extractedText);
                
                // Populate the EDITABLE input fields
                document.getElementById('extractedTrxIdInput').value = extractedData.trxIdLast4 || '';
                document.getElementById('extractedDateInput').value = extractedData.date || '';
                document.getElementById('extractedTimeInput').value = extractedData.time || '';
                document.getElementById('extractedAmountInput').value = extractedData.amount ? parseFloat(extractedData.amount).toFixed(2) : '0.00';
                
                document.getElementById('saveButton').disabled = false;
                
                showMessage('success', 'ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø±Ø§Ø¬Ø¹ ÙˆØ¹Ø¯Ù‘Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©".');
                
            } catch (error) {
                console.error("Scanning Error:", error);
                showMessage('error', `ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­: ${error.message}. Ù†Ø¸Ø±Ø§Ù‹ Ù„Ø£Ù† Tesseract ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©ØŒ Ù„Ø§ ÙŠØ²Ø§Ù„ Ø¨Ø¥Ù…ÙƒØ§Ù†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙˆØ­ÙØ¸Ù‡Ø§.`);
            } finally {
                setLoading('scanButton', false);
            }
        }

        /** Step 2: Save Edited Data to LocalStorage */
        async function handleSaveTransaction() {
            const saveButton = document.getElementById('saveButton');
            if (saveButton.disabled) return;

            setLoading('saveButton', true, 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...');

            try {
                // Read data directly from the editable input fields
                const data = {
                    date: document.getElementById('extractedDateInput').value || 'N/A', 
                    time: document.getElementById('extractedTimeInput').value || 'N/A',
                    trxIdLast4: document.getElementById('extractedTrxIdInput').value || 'N/A',
                    amount: parseFloat(document.getElementById('extractedAmountInput').value) || 0,
                };

                if (data.amount === 0) {
                     showMessage('error', 'Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙØ±Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©.');
                     setLoading('saveButton', false);
                     return;
                }

                saveTransaction(data); // Call the local storage save function

                // Reset fields after successful save
                document.getElementById('extractedDateInput').value = '';
                document.getElementById('extractedTimeInput').value = '';
                document.getElementById('extractedTrxIdInput').value = '';
                document.getElementById('extractedAmountInput').value = '0.00';
                document.getElementById('saveButton').disabled = true;

                
            } catch (error) {
                console.error("Saving Error:", error);
                showMessage('error', `ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${error.message}`);
            } finally {
                setLoading('saveButton', false, 'Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
            }
        }
        window.handleSaveTransaction = handleSaveTransaction; // Make accessible from HTML
        
        
        /** Step 5: Filter Handler */
        function handleMonthFilter() {
            const monthYearInput = document.getElementById('monthYearInput').value.trim();
            const regex = /^(\d{4})-(\d{2})$/; // YYYY-MM format
            
            let filteredTransactions = transactionsData;

            if (monthYearInput !== "") {
                if (!regex.test(monthYearInput)) {
                    showMessage('error', 'ØµÙŠØºØ© Ø§Ù„Ø´Ù‡Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† YYYY-MMØŒ Ù…Ø«Ù„ 2024-05.', 'messageContainer');
                    return;
                }

                const [_, year, month] = monthYearInput.match(regex);
                
                filteredTransactions = transactionsData.filter(trx => {
                    if (trx.date && trx.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        return trx.date.startsWith(`${year}-${month}`);
                    }
                    return false;
                });
                showMessage('success', `ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰: ${monthYearInput}.`);
            } else {
                 showMessage('success', 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØµÙÙŠØ©. Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª.');
            }

            displayTransactionsHistory(filteredTransactions);
        }
        window.handleMonthFilter = handleMonthFilter; 


        /** Step 4: Display Transaction History */
        function displayTransactionsHistory(transactions = transactionsData) {
            const transactionsList = document.getElementById('transactionsList');
            let totalAmount = 0; 
            
            transactionsList.innerHTML = '<p class="text-center text-gray-500 p-4">Ø¬Ø§Ø±Ù Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...</p>';


            // Calculate total sum for filtered/all data
            transactions.forEach((data) => {
                totalAmount += (parseFloat(data.amount) || 0); 
            });

            // --- Display Total Sum ---
            const totalDisplay = document.getElementById('totalSumDisplay');
            totalDisplay.innerHTML = `
                <div class="p-4 bg-gray-100 border-2 border-gray-300 rounded-lg text-center">
                    <p class="text-sm font-medium text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</p>
                    <p class="text-3xl font-extrabold text-indigo-700 mt-1 ltr-input">$${totalAmount.toFixed(2)}</p>
                </div>
            `;
            
            let html = '';
            transactions.forEach((data) => {
                const dateYMD = data.date || 'N/A';
                const time = data.time || '';
                const amount = data.amount ? parseFloat(data.amount).toFixed(2) : '0.00';
                const trxId = data.trxIdLast4 || '----';
                
                // Convert YYYY-MM-DD to DD-MM-YYYY for display
                let dateDmy = dateYMD;
                if (dateYMD !== 'N/A' && dateYMD.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [year, month, day] = dateYMD.split('-');
                    dateDmy = `${day}-${month}-${year}`; 
                }
                
                html += `
                    <div class="p-4 bg-white rounded-lg border-b border-gray-200 flex justify-between items-center transition hover:bg-gray-50">
                        <div class="space-y-0.5 text-right">
                            <p class="text-base font-semibold text-gray-800">Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø¢Ø®Ø± 4): ${trxId}</p>
                            <p class="text-xl font-extrabold text-green-700 ltr-input">$${amount}</p>
                            <p class="text-xs text-gray-500">${dateDmy} ÙÙŠ ${time}</p>
                        </div>
                        <button onclick="deleteTransaction('${data.id}')" id="delete-${data.id}" class="text-red-500 hover:text-red-700 p-2 rounded-full transition" title="Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
            });

            transactionsList.innerHTML = html.length > 0 ? html : '<p class="text-center text-gray-500 p-4">Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯.</p>';
        }

        /** Initialization */
        window.onload = function() {
            // Set the initial state for the app buttons
            document.getElementById('scanButton').dataset.originalText = 'Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
            document.getElementById('saveButton').dataset.originalText = 'Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
            document.getElementById('filterButton').dataset.originalText = 'ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±';
            document.getElementById('saveButton').disabled = true;

            // Load existing data from localStorage
            loadTransactions(); 
            
            // App Listeners
            document.getElementById('scanButton').addEventListener('click', scanTransaction);
            document.getElementById('saveButton').addEventListener('click', handleSaveTransaction);
            document.getElementById('filterButton').addEventListener('click', handleMonthFilter); 
            
            // Image Preview handler and field reset 
            document.getElementById('imageInput').addEventListener('change', function(event) {
                const preview = document.getElementById('imagePreview');
                // Clear all input fields and disable save button on new image load
                document.getElementById('extractedDateInput').value = '';
                document.getElementById('extractedTimeInput').value = '';
                document.getElementById('extractedTrxIdInput').value = '';
                document.getElementById('extractedAmountInput').value = '0.00';
                document.getElementById('saveButton').disabled = true;

                if (event.target.files && event.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        document.getElementById('previewPlaceholder').classList.add('hidden');
                    }
                    reader.readAsDataURL(event.target.files[0]);
                }
            });
        };
        
        // Clean up Tesseract worker on window unload
        window.onbeforeunload = async function() {
            if (worker) {
                await worker.terminate();
            }
        };
    </script>
    <style>
        /* Minimalist Custom styles */
        .container {
            max-width: 800px;
        }
        .main-button {
            transition: background-color 0.2s, opacity 0.2s, border-color 0.2s;
            border-width: 2px;
            box-shadow: none; 
        }
        .main-button:hover:not(:disabled) {
            opacity: 0.9; 
            transform: none;
        }
        .main-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .editable-input {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            font-size: 1em;
            width: 100%;
            background-color: white;
            transition: border-color 0.2s;
            text-align: right; 
        }
        .ltr-input {
             text-align: left;
             direction: ltr;
             font-family: monospace;
        }
        .editable-input:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        #imagePreview {
            max-height: 200px;
            max-width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #eee; 
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased p-4 sm:p-8 text-right">
    
    <!-- Main Application Container -->
    <div id="appContainer" class="container mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-lg border border-gray-200 space-y-8">
        <header class="text-center border-b pb-4 flex justify-between items-start">
            <div>
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">
                    ğŸ’° Ù…Ø§Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© (Tesseract.js)
                </h1>
                <p class="mt-2 text-base text-gray-600">
                    Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Tesseract OCR ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (LocalStorage).
                </p>
                <p id="userIdDisplay" class="text-xs text-gray-500 mt-2 text-red-500">
                    *Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù…ØªØµÙØ­Ùƒ ÙÙ‚Ø· ÙˆÙ„Ù† ØªØªÙ… Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§.*
                </p>
            </div>
        </header>

        <div id="messageContainer"></div>

        <!-- SECTION 1: Image Upload and Preview -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</h2>
            <div class="border border-gray-300 rounded-lg p-4 flex flex-col items-center justify-center">
                <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                
                <div id="previewPlaceholder" class="mt-4 text-gray-400">
                    Ø³ÙŠØ¸Ù‡Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§.
                </div>
                <img id="imagePreview" class="mt-4 hidden border" alt="Transaction Preview" />
            </div>
        </section>

        <!-- SECTION 2: Scanning and Extraction (Editable) -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">2. Ù…Ø³Ø­ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
            
            <button id="scanButton"
                onclick="scanTransaction()"
                class="main-button w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 border-indigo-600 disabled:bg-gray-400">
                Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            </button>
            
            <div class="bg-white border border-gray-200 p-4 rounded-lg space-y-3">
                <h3 class="text-base font-semibold text-gray-800 mb-2">Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                    
                    <!-- TrxID (Last 4) -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù…/Ø­Ø±ÙˆÙ)</label>
                        <input type="text" id="extractedTrxIdInput" class="editable-input ltr-input" value="" placeholder="Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù…" dir="ltr" />
                    </div>
                    
                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº ($)</label>
                        <input type="number" step="0.01" id="extractedAmountInput" class="editable-input ltr-input font-bold text-green-700" value="0.00" dir="ltr" />
                    </div>
                    
                    <!-- Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø³Ù†Ø©-Ø´Ù‡Ø±-ÙŠÙˆÙ…)</label>
                        <input type="text" id="extractedDateInput" class="editable-input ltr-input" value="" placeholder="YYYY-MM-DD" dir="ltr" />
                    </div>
                    
                    <!-- Time -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆÙ‚Øª (Ø³Ø§Ø¹Ø©:Ø¯Ù‚ÙŠÙ‚Ø©)</label>
                        <input type="text" id="extractedTimeInput" class="editable-input ltr-input" value="" placeholder="HH:MM" dir="ltr" />
                    </div>
                </div>
            </div>

            <button id="saveButton"
                disabled
                onclick="handleSaveTransaction()"
                class="main-button w-full px-4 py-3 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 disabled:bg-gray-400 border-green-500">
                Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
            </button>
        </section>

        <!-- SECTION 3: Transaction History -->
        <section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">3. Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ)</h2>
            
            <!-- Date Filter Inputs -->
            <div class="bg-gray-100 p-4 rounded-lg border border-gray-300 space-y-3">
                <h3 class="text-base font-semibold text-gray-700">Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label for="monthYearInput" class="block text-xs font-medium text-gray-600 mb-1">Ø´Ù‡Ø± Ø§Ù„ØªØµÙÙŠØ© (Ø³Ù†Ø©-Ø´Ù‡Ø±)</label>
                        <input type="text" id="monthYearInput" class="editable-input ltr-input" placeholder="Ù…Ø«Ø§Ù„: 2024-05" dir="ltr" />
                    </div>
                    <div class="self-end">
                        <button id="filterButton" onclick="handleMonthFilter()" class="main-button w-full px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300 border-gray-300">
                            ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±
                        </button>
                    </div>
                </div>
            </div>

            <!-- Total Sum Display -->
            <div id="totalSumDisplay" class="my-6">
                <!-- Total sum card will be injected here -->
            </div>
            
            <div id="transactionsList" class="space-y-3">
                <p class="text-center text-gray-500 p-4">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...</p>
            </div>
        </section>
        
        <!-- Custom Delete Confirmation Modal -->
        <div id="confirmDeleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm">
                <h3 class="text-lg font-bold text-red-600 mb-3">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                <p class="text-gray-700 mb-4">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù‡Ø°Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ</p>
                <div class="flex justify-start space-x-3 space-x-reverse">
                    <button id="cancelDeleteButton" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
                    <button id="confirmDeleteButton" class="px-4 py-2 text-white bg-red-600 rounded-md hover:bg-red-700 transition">Ø­Ø°Ù</button>
                </div>
            </div>
        </div>
    </div>
    
</body>
</html>
